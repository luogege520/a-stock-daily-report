#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Aè‚¡æ™šé—´å¤ç›˜æŠ¥å‘Šç”Ÿæˆå™¨
è‡ªåŠ¨ç”Ÿæˆæ¯æ—¥Aè‚¡å¸‚åœºå¤ç›˜æŠ¥å‘Š
"""

import os
import sys
from datetime import datetime
import requests
from typing import Dict, List, Optional


class AStockReportGenerator:
    """Aè‚¡å¤ç›˜æŠ¥å‘Šç”Ÿæˆå™¨"""
    
    def __init__(self, api_key: Optional[str] = None):
        """
        åˆå§‹åŒ–æŠ¥å‘Šç”Ÿæˆå™¨
        
        Args:
            api_key: StepFun APIå¯†é’¥ï¼Œå¦‚æœä¸æä¾›åˆ™ä»ç¯å¢ƒå˜é‡è¯»å–
        """
        self.api_key = api_key or os.getenv('STEPFUN_API_KEY')
        if not self.api_key:
            raise ValueError("è¯·è®¾ç½® STEPFUN_API_KEY ç¯å¢ƒå˜é‡")
        
        self.api_base = "https://api.stepfun.com/v1"
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
    
    def search_market_data(self, query: str, topk: int = 10) -> List[Dict]:
        """
        æœç´¢å¸‚åœºæ•°æ®
        
        Args:
            query: æœç´¢æŸ¥è¯¢
            topk: è¿”å›ç»“æœæ•°é‡
            
        Returns:
            æœç´¢ç»“æœåˆ—è¡¨
        """
        # è¿™é‡Œä½¿ç”¨ StepFun çš„æœç´¢ API
        # å®é™…å®ç°éœ€è¦æ ¹æ® StepFun API æ–‡æ¡£è°ƒæ•´
        print(f"ğŸ” æœç´¢: {query}")
        
        # æ¨¡æ‹Ÿæœç´¢ç»“æœï¼ˆå®é™…åº”è¯¥è°ƒç”¨çœŸå®APIï¼‰
        return []
    
    def generate_report(self, date_str: Optional[str] = None) -> str:
        """
        ç”Ÿæˆå¤ç›˜æŠ¥å‘Š
        
        Args:
            date_str: æ—¥æœŸå­—ç¬¦ä¸²ï¼Œæ ¼å¼ï¼šYYYY-MM-DDï¼Œé»˜è®¤ä¸ºä»Šå¤©
            
        Returns:
            ç”Ÿæˆçš„æŠ¥å‘Šå†…å®¹ï¼ˆMarkdownæ ¼å¼ï¼‰
        """
        if date_str is None:
            date_str = datetime.now().strftime("%Y-%m-%d")
        
        print(f"ğŸ“Š å¼€å§‹ç”Ÿæˆ {date_str} çš„Aè‚¡å¤ç›˜æŠ¥å‘Š...")
        
        # æ„å»ºæç¤ºè¯
        prompt = self._build_prompt(date_str)
        
        # è°ƒç”¨ AI ç”ŸæˆæŠ¥å‘Š
        report_content = self._call_ai_api(prompt)
        
        return report_content
    
    def _build_prompt(self, date_str: str) -> str:
        """æ„å»ºç”ŸæˆæŠ¥å‘Šçš„æç¤ºè¯"""
        year, month, day = date_str.split('-')
        
        prompt = f"""è¯·å¸®æˆ‘ç”Ÿæˆä¸€ä»½ã€{year}å¹´{month}æœˆ{day}æ—¥ã€‘Aè‚¡æ™šé—´å¤ç›˜æŠ¥å‘Šï¼Œè¦æ±‚å¦‚ä¸‹ï¼š

## ä¸€ã€æ•°æ®æ”¶é›†èŒƒå›´
1. Aè‚¡ä¸»è¦æŒ‡æ•°ï¼šä¸Šè¯æŒ‡æ•°ã€æ·±è¯æˆæŒ‡ã€åˆ›ä¸šæ¿æŒ‡ã€ç§‘åˆ›50ã€åŒ—è¯50ï¼ˆæ”¶ç›˜ç‚¹ä½ã€æ¶¨è·Œå¹…ã€æˆäº¤é¢ã€æ¶¨è·Œå®¶æ•°ï¼‰
2. å¤–å›´å¸‚åœºï¼šç¾è‚¡ä¸‰å¤§æŒ‡æ•°ï¼ˆé“ç¼æ–¯ã€æ ‡æ™®500ã€çº³æ–¯è¾¾å…‹ï¼‰ã€æ¬§æ´²ä¸»è¦æŒ‡æ•°ï¼ˆå¯Œæ—¶100ã€DAXã€CAC40ï¼‰
3. æ¿å—è¡¨ç°ï¼šé¢†æ¶¨æ¿å—TOP10ã€é¢†è·Œæ¿å—TOP5ï¼ˆæ¶¨è·Œå¹…ã€æ ¸å¿ƒé©±åŠ¨å› ç´ ï¼‰
4. èµ„é‡‘æµå‘ï¼š
   - ä¸»åŠ›èµ„é‡‘å‡€æµå…¥/æµå‡ºTOP10ä¸ªè‚¡
   - è¡Œä¸šèµ„é‡‘æµå‘TOP5
   - **åŒ—å‘èµ„é‡‘æµå‘**ï¼ˆæ²ªè‚¡é€šã€æ·±è‚¡é€šå‡€æµå…¥é¢ï¼Œé‡ç‚¹åŠ ä»“/å‡ä»“æ¿å—ï¼Œå‡€æµå…¥/æµå‡ºTOP10ä¸ªè‚¡ï¼‰
5. çƒ­ç‚¹é¢˜æï¼šå½“æ—¥3-5ä¸ªæ ¸å¿ƒçƒ­ç‚¹çš„æ·±åº¦è§£æï¼ˆå‚¬åŒ–å‰‚ã€äº§ä¸šé€»è¾‘ã€æ¶¨åœä¸ªè‚¡ï¼‰
6. æ”¿ç­–é¢ï¼šè´§å¸æ”¿ç­–ã€äº§ä¸šæ”¿ç­–ã€ç›‘ç®¡æ€åº¦
7. æŠ€æœ¯é¢ï¼šä¸Šè¯æŒ‡æ•°å’Œåˆ›ä¸šæ¿æŒ‡çš„æŠ€æœ¯å½¢æ€ã€æ”¯æ’‘é˜»åŠ›ä½ã€è¶‹åŠ¿åˆ¤æ–­

## äºŒã€æŠ¥å‘Šç»“æ„ï¼ˆMarkdownæ ¼å¼ï¼‰

### 1. å¸‚åœºæ¦‚å†µ
- ä¸»è¦æŒ‡æ•°è¡¨ç°ï¼ˆè¡¨æ ¼å½¢å¼ï¼‰
- å¸‚åœºç‰¹å¾æ€»ç»“ï¼ˆæˆäº¤é¢ã€æ¶¨è·Œå®¶æ•°ã€å¸‚åœºæƒ…ç»ªï¼‰
- å¤–å›´å¸‚åœºè¡¨ç°ï¼ˆç¾è‚¡ã€æ¬§è‚¡ï¼‰

### 2. æ¿å—è¡¨ç°åˆ†æ
- é¢†æ¶¨æ¿å—TOP10ï¼ˆè¡¨æ ¼ï¼šæ’åã€æ¿å—åç§°ã€æ¶¨è·Œå¹…ã€æ ¸å¿ƒé©±åŠ¨å› ç´ ï¼‰
- é¢†è·Œæ¿å—ï¼ˆè¡¨æ ¼ï¼šæ¿å—åç§°ã€æ¶¨è·Œå¹…ã€è°ƒæ•´åŸå› ï¼‰

### 3. èµ„é‡‘æµå‘åˆ†æ
- ä¸»åŠ›èµ„é‡‘å‡€æµå…¥TOP10ï¼ˆè¡¨æ ¼ï¼šæ’åã€è‚¡ç¥¨åç§°ã€å‡€æµå…¥é‡‘é¢ã€æ¶¨è·Œå¹…ã€æ‰€å±æ¿å—ï¼‰
- ä¸»åŠ›èµ„é‡‘å‡€æµå‡ºTOP5ï¼ˆè¡¨æ ¼ï¼šæ’åã€è‚¡ç¥¨åç§°ã€å‡€æµå‡ºé‡‘é¢ã€æ¶¨è·Œå¹…ã€æ‰€å±æ¿å—ï¼‰
- è¡Œä¸šèµ„é‡‘æµå‘ï¼ˆå‡€æµå…¥/æµå‡ºè¡Œä¸šTOP5ï¼‰
- **åŒ—å‘èµ„é‡‘æµå‘**ï¼š
  - å½“æ—¥å‡€æµå…¥æƒ…å†µï¼ˆæ²ªè‚¡é€šã€æ·±è‚¡é€šã€åˆè®¡ï¼‰
  - åŒ—å‘èµ„é‡‘é‡ç‚¹åŠ ä»“æ¿å—TOP5
  - åŒ—å‘èµ„é‡‘é‡ç‚¹å‡ä»“æ¿å—TOP5
  - åŒ—å‘èµ„é‡‘å‡€æµå…¥TOP10ä¸ªè‚¡ï¼ˆè¡¨æ ¼ï¼‰
  - åŒ—å‘èµ„é‡‘å‡€æµå‡ºTOP5ä¸ªè‚¡ï¼ˆè¡¨æ ¼ï¼‰
  - åŒ—å‘èµ„é‡‘æµå‘ç‰¹å¾åˆ†æï¼ˆåå¥½æ–¹å‘ã€è§„é¿æ–¹å‘ï¼‰
  - åŒ—å‘èµ„é‡‘è¶‹åŠ¿ï¼ˆè¿‘5æ—¥ã€è¿‘10æ—¥ç´¯è®¡æµå‘ï¼‰

### 4. çƒ­ç‚¹é¢˜ææ·±åº¦è§£æ
é’ˆå¯¹å½“æ—¥3-5ä¸ªæ ¸å¿ƒçƒ­ç‚¹ï¼Œæ¯ä¸ªçƒ­ç‚¹åŒ…æ‹¬ï¼š
- æ ¸å¿ƒå‚¬åŒ–å‰‚ï¼ˆæ¶ˆæ¯é¢ã€æ”¿ç­–é¢ï¼‰
- äº§ä¸šé€»è¾‘ï¼ˆéœ€æ±‚ã€æŠ€æœ¯ã€ä¾›åº”ç­‰ï¼‰
- æ¶¨åœä¸ªè‚¡åˆ—è¡¨
- åç»­å…³æ³¨æ–¹å‘

### 5. æ”¿ç­–ä¸å®è§‚é¢
- è´§å¸æ”¿ç­–ï¼ˆå¤®è¡Œæ“ä½œã€æ”¿ç­–è¡¨æ€ï¼‰
- äº§ä¸šæ”¿ç­–ï¼ˆè®¾å¤‡æ›´æ–°ã€æ¶ˆè´¹åˆºæ¿€ã€æˆ˜ç•¥æ–°å…´äº§ä¸šï¼‰
- ç›‘ç®¡æ€åº¦ï¼ˆé£é™©æç¤ºï¼‰

### 6. æŠ€æœ¯é¢åˆ†æ
- ä¸Šè¯æŒ‡æ•°ï¼šå½“å‰ä½ç½®ã€æŠ€æœ¯å½¢æ€ã€æ”¯æ’‘é˜»åŠ›ä½ã€é‡èƒ½åˆ†æã€è¶‹åŠ¿åˆ¤æ–­
- åˆ›ä¸šæ¿æŒ‡ï¼šå½“å‰ä½ç½®ã€æŠ€æœ¯å½¢æ€ã€æ”¯æ’‘é˜»åŠ›ä½ã€è¶‹åŠ¿åˆ¤æ–­

### 7. æŠ•èµ„ç­–ç•¥å»ºè®®
- çŸ­æœŸç­–ç•¥ï¼ˆ1-2å‘¨ï¼‰ï¼šæ ¸å¿ƒä¸»çº¿ã€é˜²å¾¡ç­–ç•¥ã€æ“ä½œå»ºè®®
- ä¸­é•¿æœŸç­–ç•¥ï¼ˆ1-3ä¸ªæœˆï¼‰ï¼šæ ¸å¿ƒèµ›é“ã€é…ç½®å»ºè®®ï¼ˆæˆé•¿è‚¡/ä»·å€¼è‚¡/ç°é‡‘æ¯”ä¾‹ï¼‰

### 8. é£é™©æç¤º
åˆ—å‡º5å¤§é£é™©ï¼šæ”¿ç­–é£é™©ã€å¤–éƒ¨é£é™©ã€ä¸šç»©é£é™©ã€æŠ€æœ¯é£é™©ã€æµåŠ¨æ€§é£é™©

### 9. æ€»ç»“ä¸å±•æœ›
- å½“æ—¥å¸‚åœºç‰¹å¾
- æ ¸å¿ƒé©±åŠ¨å› ç´ 
- å…¨çƒå¸‚åœºè”åŠ¨
- åå¸‚å±•æœ›ï¼ˆçŸ­æœŸã€ä¸­æœŸã€æ“ä½œç­–ç•¥ï¼‰

## ä¸‰ã€æ ¼å¼è¦æ±‚

1. **è¡¨æ ¼æ ¼å¼ï¼š** æ‰€æœ‰æ•°æ®ç”¨Markdownè¡¨æ ¼å‘ˆç°ï¼Œæ¸…æ™°æ˜“è¯»
2. **æ•°æ®æ ‡æ³¨ï¼š** 
   - ä¸Šæ¶¨æ•°æ®ç”¨çº¢è‰²æ ‡æ³¨ï¼ˆå¦‚ï¼š+0.33%ï¼‰
   - ä¸‹è·Œæ•°æ®ç”¨ç»¿è‰²æ ‡æ³¨ï¼ˆå¦‚ï¼š-0.57%ï¼‰
   - é‡è¦æ•°æ®åŠ ç²—
3. **ç¬¦å·ä½¿ç”¨ï¼š**
   - ğŸ”¥ è¡¨ç¤ºçƒ­ç‚¹é¢˜æ
   - ğŸš€ è¡¨ç¤ºå•†ä¸šèˆªå¤©ç­‰ç§‘æŠ€é¢˜æ
   - ğŸ’° è¡¨ç¤ºè´µé‡‘å±ã€èµ„é‡‘ç±»é¢˜æ
   - âœ… è¡¨ç¤ºæ­£é¢å› ç´ 
   - âš ï¸ è¡¨ç¤ºé£é™©æç¤º
4. **å±‚çº§ç»“æ„ï¼š** ä½¿ç”¨äºŒçº§ã€ä¸‰çº§æ ‡é¢˜æ¸…æ™°åˆ’åˆ†ç« èŠ‚
5. **æ•°æ®ç²¾åº¦ï¼š** 
   - ç‚¹ä½ä¿ç•™2ä½å°æ•°
   - æ¶¨è·Œå¹…ä¿ç•™2ä½å°æ•°
   - èµ„é‡‘æµå‘ä¿ç•™2ä½å°æ•°ï¼ˆäº¿å…ƒï¼‰
6. **è¯­è¨€é£æ ¼ï¼š** ä¸“ä¸šã€å®¢è§‚ã€ç®€æ´ï¼Œé¿å…ä¸»è§‚è‡†æ–­

## å››ã€æ•°æ®æ¥æºæ ‡æ³¨

æŠ¥å‘Šæœ«å°¾æ³¨æ˜ï¼š
- æŠ¥å‘Šç”Ÿæˆæ—¶é—´
- æ•°æ®æ¥æºï¼ˆå¦‚ï¼šWindã€ä¸œæ–¹è´¢å¯Œã€è¯åˆ¸æ—¶æŠ¥ã€é‡‘åæ•°æ®ï¼‰
- å…è´£å£°æ˜

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸Šç»“æ„å’Œæ ¼å¼ç”ŸæˆæŠ¥å‘Šã€‚"""
        
        return prompt
    
    def _call_ai_api(self, prompt: str) -> str:
        """
        è°ƒç”¨ AI API ç”ŸæˆæŠ¥å‘Š
        
        Args:
            prompt: æç¤ºè¯
            
        Returns:
            ç”Ÿæˆçš„æŠ¥å‘Šå†…å®¹
        """
        print("ğŸ¤– è°ƒç”¨ AI ç”ŸæˆæŠ¥å‘Š...")
        
        # è¿™é‡Œéœ€è¦å®ç°å®é™…çš„ API è°ƒç”¨
        # ç”±äºéœ€è¦ä½¿ç”¨ StepFun çš„ç‰¹å®š APIï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªæ¡†æ¶
        
        url = f"{self.api_base}/chat/completions"
        
        payload = {
            "model": "step-1-32k",  # ä½¿ç”¨åˆé€‚çš„æ¨¡å‹
            "messages": [
                {
                    "role": "system",
                    "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„Aè‚¡å¸‚åœºåˆ†æå¸ˆï¼Œæ“…é•¿æ’°å†™è¯¦ç»†çš„å¸‚åœºå¤ç›˜æŠ¥å‘Šã€‚"
                },
                {
                    "role": "user",
                    "content": prompt
                }
            ],
            "temperature": 0.7,
            "max_tokens": 16000
        }
        
        try:
            response = requests.post(url, json=payload, headers=self.headers, timeout=300)
            response.raise_for_status()
            
            result = response.json()
            content = result['choices'][0]['message']['content']
            
            print("âœ… æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼")
            return content
            
        except Exception as e:
            print(f"âŒ ç”ŸæˆæŠ¥å‘Šå¤±è´¥: {e}")
            raise
    
    def save_report(self, content: str, output_dir: str = "reports") -> str:
        """
        ä¿å­˜æŠ¥å‘Šåˆ°æ–‡ä»¶
        
        Args:
            content: æŠ¥å‘Šå†…å®¹
            output_dir: è¾“å‡ºç›®å½•
            
        Returns:
            ä¿å­˜çš„æ–‡ä»¶è·¯å¾„
        """
        # åˆ›å»ºè¾“å‡ºç›®å½•
        os.makedirs(output_dir, exist_ok=True)
        
        # ç”Ÿæˆæ–‡ä»¶å
        date_str = datetime.now().strftime("%Y-%m-%d")
        filename = f"Aè‚¡æ™šé—´å¤ç›˜æŠ¥å‘Š_{date_str}.md"
        filepath = os.path.join(output_dir, filename)
        
        # ä¿å­˜æ–‡ä»¶
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        
        print(f"ğŸ’¾ æŠ¥å‘Šå·²ä¿å­˜åˆ°: {filepath}")
        return filepath


def main():
    """ä¸»å‡½æ•°"""
    try:
        # åˆ›å»ºæŠ¥å‘Šç”Ÿæˆå™¨
        generator = AStockReportGenerator()
        
        # ç”ŸæˆæŠ¥å‘Š
        report_content = generator.generate_report()
        
        # ä¿å­˜æŠ¥å‘Š
        filepath = generator.save_report(report_content)
        
        print(f"\nğŸ‰ æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼")
        print(f"ğŸ“„ æ–‡ä»¶è·¯å¾„: {filepath}")
        
        return filepath
        
    except Exception as e:
        print(f"\nâŒ é”™è¯¯: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
