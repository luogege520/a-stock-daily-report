# 🤖 多模型支持说明

## ✨ 功能特性

系统现在支持 **3 个 AI 模型**，可以自动轮换和故障转移：

1. **Google Gemini** (gemini-2.5-pro)
2. **StepFun** (step-2-16k)
3. **DeepSeek** (deepseek-chat)

### 核心优势

- ✅ **自动故障转移**：如果一个模型失败，自动切换到下一个
- ✅ **灵活配置**：可以指定首选模型
- ✅ **多重保障**：至少配置一个模型即可运行
- ✅ **成本优化**：可以根据成本和配额灵活选择

---

## 🔧 配置方法

### 方法 1：配置所有模型（推荐）

在 GitHub Secrets 中添加所有 3 个 API Key：

| Secret 名称 | 说明 | 获取方式 |
|------------|------|---------|
| `GEMINI_API_KEY` | Google Gemini API 密钥 | [Google AI Studio](https://makersuite.google.com/app/apikey) |
| `STEPFUN_API_KEY` | StepFun API 密钥 | [StepFun 平台](https://platform.stepfun.com/) |
| `DEEPSEEK_API_KEY` | DeepSeek API 密钥 | [DeepSeek 平台](https://platform.deepseek.com/) |

**优势**：
- 🛡️ 最高可靠性：一个失败自动切换
- 💰 成本优化：可以轮换使用
- 📊 配额管理：避免单一模型配额用完

### 方法 2：只配置一个模型

至少配置一个 API Key 即可运行：

```bash
# 例如只使用 Gemini
GEMINI_API_KEY=your_gemini_key
```

### 方法 3：指定首选模型

通过 `PREFERRED_AI_MODEL` 指定首选模型：

```bash
# 首选 Gemini
PREFERRED_AI_MODEL=Gemini

# 首选 StepFun  
PREFERRED_AI_MODEL=StepFun

# 首选 DeepSeek
PREFERRED_AI_MODEL=DeepSeek
```

如果首选模型失败，会自动切换到其他可用模型。

---

## 📊 模型对比

| 特性 | Gemini 2.5 Pro | StepFun | DeepSeek |
|------|---------------|---------|----------|
| **免费额度** | 1500次/天 | 需付费 | 需付费 |
| **请求限制** | 5次/分钟 | 较高 | 较高 |
| **输出长度** | 8192 tokens | 16000 tokens | 8000 tokens |
| **响应速度** | 快 | 快 | 快 |
| **中文能力** | 优秀 | 优秀 | 优秀 |
| **成本** | 免费 | 付费 | 付费 |
| **推荐场景** | 日常使用 | 高频使用 | 高频使用 |

---

## 🚀 使用示例

### 示例 1：自动选择模型

不指定首选模型，系统自动选择第一个可用的：

```python
generator = AStockReportGenerator()
report = generator.generate_report()
```

**执行流程**：
1. 尝试 Gemini（如果配置了）
2. 如果失败，尝试 StepFun
3. 如果失败，尝试 DeepSeek
4. 如果都失败，返回备用报告

### 示例 2：指定首选模型

```python
# 首选 Gemini
generator = AStockReportGenerator(preferred_model="Gemini")

# 首选 StepFun
generator = AStockReportGenerator(preferred_model="StepFun")

# 首选 DeepSeek
generator = AStockReportGenerator(preferred_model="DeepSeek")
```

### 示例 3：通过环境变量指定

```bash
# 设置首选模型
export PREFERRED_AI_MODEL=Gemini

# 运行
python main.py
```

---

## 🔄 故障转移机制

### 自动切换流程

```
1. 尝试首选模型（如果指定）
   ↓ 失败
2. 尝试第一个可用模型
   ↓ 失败
3. 尝试第二个可用模型
   ↓ 失败
4. 尝试第三个可用模型
   ↓ 失败
5. 返回备用报告（包含原始数据）
```

### 日志输出示例

```
[INFO] 初始化 AI 模型客户端...
[INFO] ✅ Gemini 客户端已加载
[INFO] ✅ StepFun 客户端已加载
[INFO] ✅ DeepSeek 客户端已加载
[INFO] 共加载 3 个模型客户端

[INFO] 尝试使用首选模型: Gemini
[ERROR] Gemini HTTP 错误: 429 Resource Exhausted
[INFO] 切换到下一个模型...

[INFO] 尝试使用模型: StepFun
[INFO] ✅ StepFun 生成成功 (长度: 8567 字符)

✅ 使用模型: StepFun
```

---

## 💡 最佳实践

### 1. 推荐配置

**日常使用**（免费）：
```bash
GEMINI_API_KEY=your_gemini_key
```

**高可靠性**（推荐）：
```bash
GEMINI_API_KEY=your_gemini_key
STEPFUN_API_KEY=your_stepfun_key
DEEPSEEK_API_KEY=your_deepseek_key
```

**成本优化**：
```bash
# 首选免费的 Gemini
GEMINI_API_KEY=your_gemini_key
STEPFUN_API_KEY=your_stepfun_key
PREFERRED_AI_MODEL=Gemini
```

### 2. 配额管理

**Gemini 免费层级限制**：
- 每分钟 5 次请求
- 每天 1500 次请求
- 本项目每天 1 次，完全够用

**如果 Gemini 配额用完**：
- 自动切换到 StepFun 或 DeepSeek
- 无需手动干预

### 3. 成本控制

**策略 1：优先使用免费模型**
```bash
PREFERRED_AI_MODEL=Gemini
```

**策略 2：轮换使用**
- 周一、三、五：Gemini
- 周二、四：StepFun
- 可以通过脚本实现

**策略 3：按配额使用**
- Gemini 配额充足时使用 Gemini
- 配额不足时自动切换

---

## 🔍 故障排查

### 问题 1：所有模型都失败

**错误信息**：
```
❌ 所有 AI 模型都调用失败
```

**检查清单**：
- [ ] 至少配置了一个 API Key
- [ ] API Key 格式正确
- [ ] API Key 有效且未过期
- [ ] 网络连接正常
- [ ] API 配额充足

### 问题 2：特定模型失败

**Gemini 失败**：
```
[ERROR] Gemini HTTP 错误: 429 Resource Exhausted
```
- 原因：配额用完或请求太频繁
- 解决：等待配额重置，或使用其他模型

**StepFun 失败**：
```
[ERROR] StepFun HTTP 错误: 401 Unauthorized
```
- 原因：API Key 无效
- 解决：检查 API Key 是否正确

**DeepSeek 失败**：
```
[ERROR] DeepSeek 连接错误
```
- 原因：网络问题
- 解决：检查网络连接

### 问题 3：如何查看使用了哪个模型？

查看日志输出：
```
✅ 使用模型: Gemini
```

或查看生成的报告末尾。

---

## 📝 API 密钥获取

### 1. Gemini API Key

1. 访问：https://makersuite.google.com/app/apikey
2. 登录 Google 账号
3. 点击 "Create API Key"
4. 复制密钥（格式：`AIzaSy...`）

### 2. StepFun API Key

1. 访问：https://platform.stepfun.com/
2. 注册/登录账号
3. 进入 API 管理
4. 创建 API Key
5. 复制密钥

### 3. DeepSeek API Key

1. 访问：https://platform.deepseek.com/
2. 注册/登录账号
3. 进入 API Keys 页面
4. 创建新的 API Key
5. 复制密钥

---

## 🎯 总结

### 优势

✅ **高可靠性**：多模型备份，一个失败自动切换  
✅ **灵活配置**：可以只用一个，也可以用多个  
✅ **成本优化**：优先使用免费模型  
✅ **简单易用**：无需修改代码，只需配置环境变量

### 推荐配置

**最低配置**（免费）：
```bash
GEMINI_API_KEY=your_key
```

**推荐配置**（高可靠性）：
```bash
GEMINI_API_KEY=your_gemini_key
STEPFUN_API_KEY=your_stepfun_key
DEEPSEEK_API_KEY=your_deepseek_key
PREFERRED_AI_MODEL=Gemini
```

---

**更新时间**：2026-01-29  
**版本**：v2.2.0 (Multi-Model Support)
